angular.module("app",["ionic","jett.ionic.filter.bar","ui.router"]).controller("HomeCtrl",["$scope","$timeout","$state","sharedService","$ionicScrollDelegate","$ionicFilterBar","$ionicSideMenuDelegate","$ionicLoading","$ionicPopup",function(a,e,t,r,s,n,o,i,l){function h(e){a.shareData.menuSelected=null,a.shareData.unique="__rowNum__",a.shareData.term=null,a.shareData.subterm=null,a.shareData.group=null,a.shareData.initContents=JSON.stringify(e);var t=null;try{var r=Object.keys(e[0]);a.shareData.headerKeys=r.filter(function(e,r){return e!==a.shareData.unique||(t=r,!1)}),a.shareData.headerValues=r.map(function(a){return e[0][a]}).filter(function(a,e){return e!==t});var s=null;if(a.shareData.headerValues.forEach(function(e,t){"表示"===e&&(s=a.shareData.headerKeys[t])}),e=e.filter(function(a,e){return!a[s]}),a.shareData.rawList=angular.copy(e.slice(1)),a.shareData.itemList=a.shareData.rawList,a.shareData.drugs=[],a.shareData.headerValues.forEach(function(e,t){try{e.indexOf("[T]")>-1&&!a.shareData.term?(a.shareData.term=a.shareData.headerKeys[t],a.shareData.headerValues[t]=e.replace("[T]","")):e.indexOf("[S]")>-1&&!a.shareData.subterm?(a.shareData.subterm=a.shareData.headerKeys[t],a.shareData.headerValues[t]=e.replace("[S]","")):e.indexOf("[G]")>-1&&!a.shareData.group&&(a.shareData.group=a.shareData.headerKeys[t],a.shareData.headerKeys[t],a.shareData.headerValues[t]=e.replace("[G]","")),e.indexOf("[drug")>-1&&a.shareData.drugs.push(a.shareData.headerKeys[t]),delete e[a.shareData.unique]}catch(a){console.log(a)}}),a.shareData.term||(a.shareData.term="A"),a.shareData.group){a.shareData.groupList=a.shareData.rawList.map(function(e){return e[a.shareData.group]}).filter(function(a,e,t){return t.map(function(a){return a}).indexOf(a)===e}).sort(function(a,e){return a.localeCompare(e)});var n=[];for(var o in a.shareData.rawList.sort(function(e,t){return e[a.shareData.group].localeCompare(t[a.shareData.group])||e[a.shareData.term].localeCompare(t[a.shareData.term])}),a.shareData.groupList.forEach(function(e){var t=a.shareData.itemList.map(function(e){return e[a.shareData.group]}).indexOf(e);n.unshift(t)}),n){var i={};i[a.shareData.term]=a.shareData.rawList[n[o]][a.shareData.group],i[a.shareData.group]=!1,i[a.shareData.unique]="divider1",a.shareData.rawList.splice(n[o],0,i)}}else a.shareData.rawList.sort(function(e,t){return e[a.shareData.term].localeCompare(t[a.shareData.term])}),a.shareData.groupList=[]}catch(a){console.log(a)}}function u(e){a.shareData.initContents1=JSON.stringify(e),a.shareData.term1=null,a.shareData.subterm1=null,a.shareData.group1=null;var t=0;a.shareData.headerKeys1=Object.keys(e[0]),a.shareData.headerValues1=a.shareData.headerKeys1.map(function(a){return e[0][a]}),a.shareData.lookupKey=a.shareData.headerKeys1[t],a.shareData.rawList1=angular.copy(e.slice(1)),a.shareData.itemList1=a.shareData.rawList1,a.shareData.rawArr1=a.shareData.rawList1.map(function(e,t){return{drug:e[a.shareData.lookupKey],infos:e}}),a.shareData.headerValues1.forEach(function(e,t){try{e.indexOf("[T]")>-1?a.shareData.headerValues1[t]=e.replace("[T]",""):e.indexOf("[S]")>-1?a.shareData.headerValues1[t]=e.replace("[S]",""):e.indexOf("[G]")>-1&&(a.shareData.headerValues1[t]=e.replace("[G]",""))}catch(a){console.log("error")}}),a.shareData.rawList1.sort(function(e,t){return e[a.shareData.lookupKey].localeCompare(t[a.shareData.lookupKey])})}function c(e){var t=indexedDB.open(D);t.onupgradeneeded=function(a){var e=a.target.result;e.createObjectStore(g,{keyPath:"id"})},t.onsuccess=function(t){var r=t.target.result,s=r.transaction(g,"readonly"),n=s.objectStore(g),o=n.get(e);o.onsuccess=function(t){switch(e){case"flags":try{a.shareData.flags=t.target.result.contents,a.shareData.flagNum=Object.keys(a.shareData.flags).length}catch(a){console.log("error",a)}break;case"contents":try{h(t.target.result.contents)}catch(e){console.log("error",e),h(initContents);try{a.shareData.updateTime="デフォルトのままです",a.shareData.setDb("updated",a.shareData.updateTime)}catch(a){}}break;case"contents1":try{u(t.target.result.contents)}catch(a){console.log("error",a);try{u(initContents1)}catch(a){console.log("error2",a)}}break;case"updated":try{a.shareData.updateTime=t.target.result.contents}catch(a){console.log("error",a)}}},o.onerror=function(e){a.shareData.hide(),console.log("db not exist")}},t.onerror=function(t){a.shareData.setDb(e,a.shareData.flags)}}function f(a){var e=indexedDB.deleteDatabase(a);e.onsuccess=function(a){console.log("db delete success")},e.onerror=function(){console.log("db delete error")}}a.shareData=r,a.shareData.flags||(a.shareData.flags={}),a.shareData.secondaryOn=!0,a.$on("$ionicView.loaded",function(a){}),a.$on("$ionicView.beforeLeave",function(a){try{document.getElementById("filterBar").style.display="none"}catch(a){console.log(a)}}),a.$on("$ionicView.beforeEnter",function(e){try{a.shareData.flagNum=Object.keys(a.shareData.flags).length,document.getElementById("filterBar").style.display="inherit"}catch(e){console.log(e)}});var D="kw_DB",g="kw_storage";c("flags"),c("contents"),c("contents1"),c("updated"),a.freezeScroll=function(){s.$getByHandle("mainScroll").getScrollView().options.scrollingY=!1},a.enableScroll=function(){s.$getByHandle("mainScroll").getScrollView().options.scrollingY=!0},a.shareData.local={en:{all:"All",flagged:"Flagged",back:"Back",search:"Search",cancel:"Cancel",def:"Definition",nav:"Navigational Note"},ja:{all:"すべて",flagged:"フラグ付き",back:"戻る",search:"検索",cancel:"キャンセル",def:"定義",nav:"検索上の注意"}},a.groupTitle={en:a.shareData.local.en.all,ja:a.shareData.local.ja.all},a.shareData.lang="ja",a.shareData.langJa=!0,a.showFilterBar=function(){o.isOpen()&&o.toggleLeft(),filterBarInstance=n.show({cancel:function(){a.shareData.search=""}})},a.shareData.getItemHeight=function(e){return a.shareData.subterm?a.shareData.group?e[a.shareData.group]?64:28:64:a.shareData.group?e[a.shareData.group]?48:28:48},a.shareData.hiraToKana=function(a){return a?a.replace(/[\u3041-\u3096]/g,function(a){var e=a.charCodeAt(0)+96;return String.fromCharCode(e)}):""},a.shareData.filteredList=function(){var e=a.shareData.hiraToKana(a.shareData.search);try{var t=[];t=a.shareData.rawList1.filter(function(t,r,s){return a.shareData.headerKeys1.some(function(a){try{return t[a].toLowerCase().indexOf(e.toLowerCase())>-1}catch(a){}})}).map(function(a){return a.A})}catch(a){}return e?a.shareData.itemList.filter(function(r,s,n){return String(r[a.shareData.unique]).indexOf("divider")>-1||a.shareData.headerKeys.some(function(a){try{return r[a].toLowerCase().indexOf(e.toLowerCase())>-1||!!t&&t.some(function(e){return r[a].toLowerCase().indexOf(e)>-1})}catch(a){}})}).filter(function(e,t,r){try{return!a.shareData.group||(!e[a.shareData.group]&&e[a.shareData.term]===r[t+1][a.shareData.group]||e[a.shareData.group])}catch(a){console.log("no data in a category")}}):a.shareData.itemList},a.shareData.encode=function(a,e){try{for(var t=e?a[e]?String(a[e]):"":a?String(a):"",r=String(t).length,s=[];r--;){var n=t[r].charCodeAt();'"'===t[r]?s[r]="&quot;":"&"===t[r]?s[r]="&amp;":s[r]=62===n?"&gt;":60===n?"&lt;":t[r]}return s.join("")?s.join("").replace(/■/g,"<span class='prefix'>■</span>"):" · · ·"}catch(a){console.log(a)}},a.shareData.headerPref=function(a){var e="",t=null;return a.indexOf("[C]")>-1&&(t=!0,a=a.replace("[C]","")),a.indexOf("[r]")>-1?(e="red",a=a.replace("[r]","")):a.indexOf("[b]")>-1?(e="blue",a=a.replace("[b]","")):a.indexOf("[y]")>-1?(e="yellow",a=a.replace("[y]","")):a.indexOf("[g]")>-1?(e="green",a=a.replace("[g]","")):e="sky",[a,e,t]},a.scrollTop=function(){s.scrollTop(!1)},a.toggleLeft=function(){s.scrollTop(!1),a.shareData.search="",o.toggleLeft(),a.shareData.flagNum=Object.keys(a.shareData.flags).length},a.flagging=function(e,t){t.preventDefault(),t.stopPropagation(),a.shareData.flags[e]?delete a.shareData.flags[e]:a.shareData.flags[e]=!0,a.shareData.setDb("flags",a.shareData.flags),a.shareData.flagNum=Object.keys(a.shareData.flags).length},a.getItem=function(e,r){var s=[];if(a.shareData.drugList=[],e){a.shareData.detail=angular.copy(a.shareData.itemList.filter(function(t){return String(t[a.shareData.unique])===String(e)})[0]);s=[];a.shareData.drugs.forEach(function(e,t){a.shareData.detail[e]&&a.shareData.drugList.push(a.shareData.detail[e]),delete a.shareData.detail[e]});try{var n=[];a.shareData.headerValues1.forEach(function(e,t){e.indexOf("r")>-1&&n.push(a.shareData.headerKeys1[t])}),cautionItems1=[],a.shareData.headerValues.forEach(function(e,t){e.indexOf("r")>-1&&!e.indexOf("[drug")>-1&&cautionItems1.push(a.shareData.headerKeys[t])}),cautionItems1.length>0&&cautionItems1.forEach(function(e){a.shareData.detail[e]&&s.unshift(a.shareData.detail[e])}),a.shareData.rawArr1.forEach(function(e){if(a.shareData.drugList.indexOf(e.drug)>-1){var t="--- "+e.infos.A+" ("+e.infos.B+") ---";n.forEach(function(a){e.infos[a]&&(s.push(t),s.push(e.infos[a]))})}})}catch(r){console.log(r)}0===s.length&&(s=["--- 一般的注意事項 ---","■化学療法中のバイタルを確認する。","■食欲低下、嘔気・嘔吐症状に留意し、食形態を考える。"]),a.shareData.cautionList=s.join("\n"),t.go("tabs.detail")}else r.preventDefault()},a.shareData.getGroupItems=function(t){t?(a.shareData.menuSelected=t,a.groupTitle={en:t,ja:t},a.shareData.itemList=a.shareData.rawList.filter(function(e){return!e[a.shareData.group]&&e[a.shareData.term]===t||e[a.shareData.group]===t})):(console.log("null",t),a.shareData.menuSelected=null,a.groupTitle={en:a.shareData.local.en.all,ja:a.shareData.local.ja.all},a.shareData.itemList=a.shareData.rawList),o.toggleLeft(),e(function(){s.$getByHandle("mainScroll").scrollTop(!1)})},a.shareData.getDrugInfos1=function(e){return console.log(e),a.shareData.rawArr1.filter(function(a){return a.drug===e})[0].infos},a.shareData.getFlag=function(){a.shareData.menuSelected="____flag____";var t=Object.keys(a.shareData.flags);a.shareData.itemList=a.shareData.rawList.filter(function(e){return!(e[a.shareData.group]||!a.shareData.group)||t.some(function(t){return Number(t)===Number(e[a.shareData.unique])})}).filter(function(e,t,r){try{return!a.shareData.group||(!e[a.shareData.group]&&e[a.shareData.term]===r[t+1][a.shareData.group]||e[a.shareData.group])}catch(a){console.log("no data in a category")}}),a.groupTitle={en:'<i class="icon ion-ios-flag red-flag head"></i>'+a.shareData.local.en.flagged,ja:'<i class="icon ion-ios-flag red-flag head"></i>'+a.shareData.local.ja.flagged},o.toggleLeft(),e(function(){s.scrollTop(!1)})},a.shareData.removeFlags=function(){var e=l.confirm({title:"Remove Flags",template:"Are you sure you want to remove all flags?"});e.then(function(e){if(e){var t={};a.shareData.flags=t,a.shareData.setDb("flags",t)}else console.log("You are not sure")})},a.shareData.setDb=function(a,e){var t=indexedDB.open(D);t.onsuccess=function(t){var r=t.target.result,s=r.transaction(g,"readwrite"),n=s.objectStore(g),o=n.put({id:a,contents:e});o.onsuccess=function(){console.log("put data success")},s.oncomplete=function(){console.log("transaction completed")},r.close()},t.onerror=function(a){console.log("db open error")}},a.shareData.dbremove=function(a){f(a)}}]).controller("DetailCtrl",["$scope","sharedService",function(a,e){a.shareData=e}]).controller("SearchCtrl",["$scope","sharedService",function(a,e){a.shareData=e}]).controller("PsCtrl",["$scope","sharedService",function(a,e){function t(a){for(var e="",t=0,r=10240;t<a.byteLength/r;++t)e+=String.fromCharCode.apply(null,new Uint8Array(a.slice(t*r,t*r+r)));return e+=String.fromCharCode.apply(null,new Uint8Array(a.slice(t*r))),e}function r(a){var e={};return a.SheetNames.forEach(function(t,r){var s=XLSX.utils.sheet_to_json(a.Sheets[t],{raw:!0,header:"A"});s.length>0&&(e[String(r)]=s)}),e}a.shareData=e,a.$on("$ionicView.enter",function(a){try{document.getElementById("filterBar").style.display="none"}catch(a){console.log(a)}});a.shareData.fileNameChanged=function(e){try{a.shareData.removeFlags()}catch(a){console.log(a)}try{var s=e.target.files,n=s[0],o=new FileReader;o.onload=function(e){var s,n=e.target.result,o=t(n);s=XLSX.read(btoa(o),{type:"base64",cellDates:!0});var i=angular.copy(r(s)[0]),l=i.map(function(a,e){return a.__rowNum__=e,a});a.shareData.setDb("contents",l),a.shareData.unique="__rowNum__",a.shareData.term=null,a.shareData.subterm=null,a.shareData.group=null;var h=null,u=null,c=Object.keys(l[0]);a.shareData.headerKeys=c.filter(function(e,t){return e!==a.shareData.unique||(u=t,!1)}),a.shareData.headerValues=c.map(function(a){return l[0][a]}).filter(function(a,e){return e!==u});var f=null;if(a.shareData.headerValues.forEach(function(e,t){"表示"===e&&(f=a.shareData.headerKeys[t])}),l=l.filter(function(a,e){return!a[f]}),a.shareData.rawList=angular.copy(l.slice(1)),a.shareData.itemList=a.shareData.rawList,a.shareData.drugs=[],a.shareData.headerValues.forEach(function(e,t){try{e.indexOf("[T]")>-1&&!a.shareData.term?(a.shareData.term=a.shareData.headerKeys[t],a.shareData.headerValues[t]=e.replace("[T]","")):e.indexOf("[S]")>-1&&!a.shareData.subterm?(a.shareData.subterm=a.shareData.headerKeys[t],a.shareData.headerValues[t]=e.replace("[S]","")):e.indexOf("[G]")>-1&&!a.shareData.group&&(a.shareData.group=a.shareData.headerKeys[t],h=a.shareData.headerKeys[t],a.shareData.headerValues[t]=e.replace("[G]","")),e.indexOf("[drug")>-1&&a.shareData.drugs.push(a.shareData.headerKeys[t])}catch(a){console.log("error")}}),a.shareData.term||(a.shareData.term="A"),a.shareData.group){a.shareData.groupList=a.shareData.rawList.map(function(a){return a[h]}).filter(function(a,e,t){return t.map(function(a){return a}).indexOf(a)===e}).sort(function(a,e){return a.localeCompare(e)});var D=[];for(var g in a.shareData.rawList.sort(function(e,t){return e[h].localeCompare(t[h])||e[a.shareData.term].localeCompare(t[a.shareData.term])}),a.shareData.groupList.forEach(function(e){var t=a.shareData.itemList.map(function(a){return a[h]}).indexOf(e);D.unshift(t)}),D){var d={};d[a.shareData.term]=a.shareData.rawList[D[g]][h],d[h]=!1,d[a.shareData.unique]="divider1",a.shareData.rawList.splice(D[g],0,d)}}else a.shareData.rawList.sort(function(e,t){return e[a.shareData.term].localeCompare(t[a.shareData.term])}),a.shareData.groupList=[];var p=angular.copy(r(s)[1]);a.shareData.setDb("contents1",p),a.shareData.term1=null,a.shareData.subterm1=null,a.shareData.group1=null;var m=0;if(a.shareData.headerKeys1=Object.keys(p[0]),a.shareData.headerValues1=a.shareData.headerKeys1.map(function(a){return p[0][a]}),a.shareData.lookupKey=a.shareData.headerKeys1[m],a.shareData.rawList1=angular.copy(p.slice(1)),a.shareData.itemList1=a.shareData.rawList1,a.shareData.rawArr1=a.shareData.rawList1.map(function(e,t){return{drug:e[a.shareData.lookupKey],infos:e}}),a.shareData.headerValues1.forEach(function(e,t){try{e.indexOf("[T]")>-1?a.shareData.headerValues1[t]=e.replace("[T]",""):e.indexOf("[S]")>-1?a.shareData.headerValues1[t]=e.replace("[S]",""):e.indexOf("[G]")>-1&&(a.shareData.headerValues1[t]=e.replace("[G]",""))}catch(a){console.log("error")}}),a.shareData.rawList1.sort(function(e,t){return e[a.shareData.lookupKey].localeCompare(t[a.shareData.lookupKey])}),n)try{a.shareData.updateTime=String(new Date),a.shareData.setDb("updated",a.shareData.updateTime)}catch(e){}},o.readAsArrayBuffer(n)}catch(a){}}}]).controller("InfoCtrl",["$scope","sharedService","$ionicPopup",function(a,e,t){a.shareData=e,a.$on("$ionicView.enter",function(a){try{document.getElementById("filterBar").style.display="none"}catch(a){console.log(a)}}),a.shareData.unregister=function(){var a=t.confirm({title:"Unregister / Remove Cashe",template:"Are you sure you want to unregister Service Worker and remove Cashe?"});a.then(function(a){a?swUnregister():console.log("You are not sure")})},a.shareData.emptyConvert=function(a){return a||" · · ·"}}]).config(["$stateProvider","$urlRouterProvider","$ionicFilterBarConfigProvider",function(a,e,t){a.state("tabs",{url:"/tabs",abstract:!0,templateUrl:"tabs.html"}).state("tabs.home",{url:"/home",views:{"tabs-home":{templateUrl:"templates/home.min.html"}}}).state("tabs.detail",{url:"/detail",views:{"tabs-home":{templateUrl:"templates/detail.min.html"}}}).state("tabs.info",{url:"/info",views:{"tabs-info":{templateUrl:"templates/info.min.html"}}}).state("tabs.privacy",{url:"/privacy",views:{"tabs-info":{templateUrl:"templates/privacy.min.html"}}}).state("tabs.term",{url:"/term",views:{"tabs-info":{templateUrl:"templates/term.min.html"}}}).state("tabs.third",{url:"/third",views:{"tabs-info":{templateUrl:"templates/third.min.html"}}}).state("tabs.about",{url:"/about",views:{"tabs-about":{templateUrl:"templates/about.min.html"}}}).state("tabs.install",{url:"/install",views:{"tabs-info":{templateUrl:"templates/install.min.html"}}}),e.otherwise("/tabs/home"),t.backdrop(!0)}]).factory("sharedService",function(){return{text:"sharedService"}}).filter("highlight",["$sce",function(a){return function(e,t){function r(a){for(var e=a.length,t=[];e--;){var r=a[e].charCodeAt();'"'===a[e]?t[e]="&quot;":"&"===a[e]?t[e]="&amp;":t[e]=62===r?"&gt;":60===r?"&lt;":a[e]}return t.join("")}function s(a){for(var e=a.length,t=[];e--;)["[","\\","^","$",".","|","?","*","+","(",")"].some(function(t){return t===a[e]})?t[e]="\\"+a[e]:t[e]=a[e];return t.join("")}return e&&t&&(e=e.replace(new RegExp("("+s(r(t))+")","gi"),'<span class="highlighted">$1</span>')),a.trustAsHtml(e?e.replace(/\n/g,"<br />"):"")}}]).config(["$ionicConfigProvider",function(a){a.navBar.positionPrimaryButtons("left"),a.tabs.position("bottom"),a.tabs.style("standard"),a.navBar.alignTitle("left"),a.backButton.text(""),a.backButton.previousTitleText("")}]).directive("onChange",function(){return{restrict:"A",link:function(a,e,t){var r=a.$eval(t.onChange);e.on("change",r),e.on("$destroy",function(){e.off()})}}});